<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Video Player</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
      }
      .mindar-ui-overlay {
        display: none !important;
      }
      .mindar-ui-scanning {
        display: none !important;
      }
      #auth-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      #auth-screen.hidden {
        display: none;
      }
      .auth-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
      }
      .auth-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 40px;
      }
      .auth-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
      }
      .auth-subtitle {
        font-size: 14px;
        color: #666;
        margin-bottom: 30px;
      }
      .auth-input {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        text-align: center;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 3px;
        font-weight: 600;
        transition: all 0.3s;
      }
      .auth-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .auth-hint {
        font-size: 12px;
        color: #999;
        margin-bottom: 20px;
      }
      .auth-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .auth-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      .auth-btn:active {
        transform: translateY(0);
      }
      .auth-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .auth-error {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 14px;
        display: none;
      }
      .auth-error.show {
        display: block;
      }
      .auth-loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }
      #app-screen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      #app-screen.active {
        display: block;
      }
      a-scene {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 0 !important;
      }
      #header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.9) 0%,
          rgba(118, 75, 162, 0.9) 100%
        );
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1000;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
      }
      #reload-btn {
        position: fixed;
        top: 70px;
        left: 10px;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.9) 0%,
          rgba(118, 75, 162, 0.9) 100%
        );
        border: 2px solid rgba(255, 255, 255, 0.5);
        color: white;
        padding: 10px 18px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        z-index: 1000;
      }
      #reload-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(118, 75, 162, 0.9) 0%,
          rgba(102, 126, 234, 0.9) 100%
        );
        transform: scale(1.05);
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 6px 18px rgba(102, 126, 234, 0.6);
      }
      #logout-btn {
        position: fixed;
        bottom: 40px;
        right: 10px;
        background: linear-gradient(
          135deg,
          rgba(231, 76, 60, 0.9) 0%,
          rgba(192, 57, 43, 0.9) 100%
        );
        border: 2px solid rgba(255, 255, 255, 0.5);
        color: white;
        padding: 10px 18px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        z-index: 1000;
      }
      #logout-btn:hover {
        background: linear-gradient(
          135deg,
          rgba(192, 57, 43, 0.9) 0%,
          rgba(231, 76, 60, 0.9) 100%
        );
        transform: scale(1.05);
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.6);
      }
      #video-title {
        color: white;
        font-size: 18px;
        font-weight: 600;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #menu-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: transform 0.3s;
      }
      #menu-btn:hover {
        transform: scale(1.1);
      }
      .menu-line {
        width: 25px;
        height: 3px;
        background: white;
        border-radius: 2px;
        transition: all 0.3s;
      }
      #menu-btn.active .menu-line:nth-child(1) {
        transform: rotate(45deg) translate(6px, 6px);
      }
      #menu-btn.active .menu-line:nth-child(2) {
        opacity: 0;
      }
      #menu-btn.active .menu-line:nth-child(3) {
        transform: rotate(-45deg) translate(6px, -6px);
      }
      #sidebar {
        position: fixed;
        top: 60px;
        right: -200px;
        width: 200px;
        height: calc(100vh - 60px);
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-left: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: -2px 0 20px rgba(0, 0, 0, 0.2);
        transition: right 0.3s ease;
        z-index: 999;
        overflow-y: auto;
      }
      #sidebar.open {
        right: 0;
      }
      #video-list {
        margin-top: 60px;
      }
      .video-item {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.2s;
        color: rgb(218, 174, 109);
      }
      .video-item:hover {
        background: #f5f5f5;
      }
      .video-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .video-item.publicidad {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-left: 4px solid #ff6b6b;
      }
      .video-item.publicidad:hover {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      }
      .video-item.publicidad.active {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }
      .video-item-title {
        font-weight: 600;
        margin-bottom: 5px;
      }
      .ad-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 8px;
        text-transform: uppercase;
      }
      .video-item-url {
        font-size: 12px;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .video-item.active .video-item-url {
        color: rgba(255, 255, 255, 0.8);
      }
      .video-item.publicidad .video-item-url {
        color: rgba(255, 255, 255, 0.9);
      }
      #play-pause-btn {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.9) 0%,
          rgba(118, 75, 162, 0.9) 100%
        );
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        z-index: 1000;
        transition: transform 0.2s, box-shadow 0.2s;
        backdrop-filter: blur(10px);
      }
      #play-pause-btn:hover {
        transform: translateX(-50%) scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }
      #play-pause-btn:active {
        transform: translateX(-50%) scale(0.95);
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 18px;
        background: rgba(0, 0, 0, 0.7);
        padding: 20px 40px;
        border-radius: 10px;
        z-index: 999;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .a-enter-vr-button {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="auth-screen">
      <div class="auth-card">
        <div class="auth-icon">üîê</div>
        <h1 class="auth-title">AR Video Player</h1>
        <p class="auth-subtitle">Ingresa tu c√≥digo de producto para acceder</p>
        <input
          type="text"
          id="product-code-input"
          class="auth-input"
          placeholder="ABC123"
          maxlength="6"
          autocomplete="off"
        />
        <p class="auth-hint">C√≥digo de 6 caracteres</p>
        <button id="auth-submit-btn" class="auth-btn">Acceder</button>
        <div id="auth-error" class="auth-error"></div>
      </div>
    </div>
    <div id="app-screen">
      <a-scene
      mindar-image="imageTargetSrc: lagaldos.mind; autoStart: false; filterMinCF: 0.0001; filterBeta: 0.01; uiScanning: none; uiLoading: no;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
        <a-assets>
          <video
            id="ar-video"
            crossorigin="anonymous"
            playsinline
            webkit-playsinline
          ></video>
          <img id="poster-image" src="myimage.png" crossorigin="anonymous" />
        </a-assets>
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0">
          <a-image
            id="poster-img"
            src="#poster-image"
            position="0 0 0"
            scale="1 1 1"
          ></a-image>
          <a-ring
            id="ring-outer"
            radius-inner="0.5"
            radius-outer="0.65"
            position="0 0 0"
            rotation="0 0 0"
            scale="0 0 0"
            material="color: #FFD700; opacity: 0.3; side: double; transparent: true"
          ></a-ring>
          <a-ring
            id="ring-inner"
            radius-inner="0.5"
            radius-outer="0.6"
            position="0 0 0"
            rotation="0 0 0"
            scale="0 0 0"
            material="color: #FFD700; opacity: 0.6; side: double; transparent: true"
          ></a-ring>

          <a-circle
            id="video-circle"
            src="#ar-video"
            radius="0.5"
            position="0 0 0"
            rotation="0 0 0"
            scale="0 0 0"
            material="shader: flat; side: double"
          ></a-circle>
        </a-entity>
      </a-scene>
      <div id="header">
        <div id="video-title">Cargando...</div>
        <button id="menu-btn">
          <div class="menu-line"></div>
          <div class="menu-line"></div>
          <div class="menu-line"></div>
        </button>
      </div>
      <button id="reload-btn"><span>üîÑ</span><span>Reload</span></button>
      <button id="logout-btn"><span>üö™</span><span>Salir</span></button>
      <div id="sidebar"><div id="video-list"></div></div>
      <button id="play-pause-btn">‚ñ∂</button>
      <div id="loading">
        <div class="loader"></div>
        <div>Cargando videos...</div>
      </div>
    </div>
    <script>
      const SUPABASE_URL = "https://gjnekbzkminxdfqqvuyo.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqbmVrYnprbWlueGRmcXF2dXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMzU3MzAsImV4cCI6MjA4MjYxMTczMH0._5OT0vM6NAClqC0o1AbSdOkd_t63Pm8EQmcj_LnA1BY";
      const VIDEO_PUBLICITARIO = "publicidad.mp4";
      const SESSION_KEY = "ar_session";
      const SESSION_DURATION = 24 * 60 * 60 * 1000;
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      let userEmail = null;
      let productCode = null;
      let videos = [];
      let currentVideoIndex = 0;
      let isPlaying = false;
      const authScreen = document.querySelector("#auth-screen");
      const appScreen = document.querySelector("#app-screen");
      const productCodeInput = document.querySelector("#product-code-input");
      const authSubmitBtn = document.querySelector("#auth-submit-btn");
      const authError = document.querySelector("#auth-error");
      const logoutBtn = document.querySelector("#logout-btn");
      const videoElement = document.querySelector("#ar-video");
      const playPauseBtn = document.querySelector("#play-pause-btn");
      const videoTitle = document.querySelector("#video-title");
      const menuBtn = document.querySelector("#menu-btn");
      const sidebar = document.querySelector("#sidebar");
      const videoList = document.querySelector("#video-list");
      const loading = document.querySelector("#loading");
      const sceneEl = document.querySelector("a-scene");
      let videoCircle = null;
      let posterImg = null;
      let ringInner = null;
      let ringOuter = null;

      let markerDetected = false;
      function checkSession() {
        const session = localStorage.getItem(SESSION_KEY);
        if (session) {
          try {
            const sessionData = JSON.parse(session);
            const now = new Date().getTime();
            if (now - sessionData.timestamp < SESSION_DURATION) {
              userEmail = sessionData.email;
              productCode = sessionData.productCode;
              showApp();
              return true;
            } else {
              localStorage.removeItem(SESSION_KEY);
            }
          } catch (e) {
            localStorage.removeItem(SESSION_KEY);
          }
        }
        return false;
      }
      function saveSession(email, code) {
        const sessionData = {
          email: email,
          productCode: code,
          timestamp: new Date().getTime(),
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
      }
      function showAuthError(message) {
        authError.textContent = message;
        authError.classList.add("show");
        setTimeout(() => {
          authError.classList.remove("show");
        }, 5000);
      }
      async function validateProductCode(code) {
        try {
          console.log("Validando c√≥digo:", code.toUpperCase());
          const { data: productData, error: productError } =
            await supabaseClient
              .from("product_codes")
              .select("code, is_used")
              .eq("code", code.toUpperCase())
              .maybeSingle();
          console.log("Resultado product_codes:", productData, productError);
          if (productError) {
            console.error("Error en product_codes:", productError);
            return {
              valid: false,
              message: "Error al validar c√≥digo: " + productError.message,
            };
          }
          if (!productData) {
            return { valid: false, message: "C√≥digo de producto no v√°lido" };
          }
          if (!productData.is_used) {
            return {
              valid: false,
              message:
                "Este c√≥digo no ha sido registrado a√∫n. Por favor reg√≠strate primero en la aplicaci√≥n web.",
            };
          }
          const { data: userData, error: userError } = await supabaseClient
            .from("user_registrations")
            .select("email, product_code")
            .eq("product_code", code.toUpperCase())
            .maybeSingle();
          console.log("Resultado user_registrations:", userData, userError);
          if (userError) {
            console.error("Error en user_registrations:", userError);
            return {
              valid: false,
              message: "Error al buscar usuario: " + userError.message,
            };
          }
          if (!userData) {
            return {
              valid: false,
              message: "No se encontr√≥ usuario asociado a este c√≥digo",
            };
          }
          console.log("Usuario encontrado:", userData.email);
          return { valid: true, email: userData.email };
        } catch (error) {
          console.error("Error general:", error);
          return {
            valid: false,
            message: "Error al validar c√≥digo: " + error.message,
          };
        }
      }
      async function handleAuth() {
        const code = productCodeInput.value.trim();
        if (code.length !== 6) {
          showAuthError("El c√≥digo debe tener 6 caracteres");
          return;
        }
        authSubmitBtn.disabled = true;
        authSubmitBtn.innerHTML =
          '<span class="auth-loader"></span>Validando...';
        const validation = await validateProductCode(code);
        if (!validation.valid) {
          showAuthError(validation.message);
          authSubmitBtn.disabled = false;
          authSubmitBtn.textContent = "Acceder";
          return;
        }
        userEmail = validation.email;
        productCode = code.toUpperCase();
        saveSession(userEmail, productCode);
        showApp();
      }
      function showApp() {
        authScreen.classList.add("hidden");
        appScreen.classList.add("active");
        initializeApp();
      }
      function logout() {
        if (confirm("¬øSeguro que deseas cerrar sesi√≥n?")) {
          localStorage.removeItem(SESSION_KEY);
          location.reload();
        }
      }
      authSubmitBtn.addEventListener("click", handleAuth);
      productCodeInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleAuth();
      });
      productCodeInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.toUpperCase();
      });
      logoutBtn.addEventListener("click", logout);
      function initializeApp() {
        sceneEl.addEventListener("loaded", () => {
          videoCircle = document.querySelector("#video-circle");
          posterImg = document.querySelector("#poster-img");
          ringInner = document.querySelector("#ring-inner");
          ringOuter = document.querySelector("#ring-outer");

          const target = document.querySelector("[mindar-image-target]");
          target.addEventListener("targetFound", () => {
            markerDetected = true;
            showPoster();
          });
          target.addEventListener("targetLost", () => {
            markerDetected = false;
          });
          const arSystem = sceneEl.systems["mindar-image-system"];
          arSystem.start();
        });
        loadVideos();
      }
      function showPoster() {
        if (posterImg && !isPlaying) {
          posterImg.setAttribute("animation", {
            property: "scale",
            from: "0 0 0",
            to: "1 1 1",
            dur: 500,
            easing: "easeInOutQuad",
          });
        }
      }
      function hidePoster() {
        if (posterImg) {
          posterImg.setAttribute("animation", {
            property: "scale",
            from: "1 1 1",
            to: "0 0 0",
            dur: 500,
            easing: "easeInOutQuad",
          });
        }
      }
      async function loadVideos() {
        try {
          const userFolder = `${userEmail}/`;
          console.log("Buscando videos en carpeta:", userFolder);

          let { data, error } = await supabaseClient.storage
            .from("videos")
            .list(userFolder, {
              limit: 100,
              sortBy: { column: "name", order: "asc" },
            });

          console.log("Respuesta de Supabase (carpeta usuario):", {
            data,
            error,
          });

          if ((!data || data.length === 0) && !error) {
            console.log("Intentando buscar en la ra√≠z del bucket...");
            const rootResult = await supabaseClient.storage
              .from("videos")
              .list("", {
                limit: 100,
                sortBy: { column: "name", order: "asc" },
              });
            console.log("Respuesta de Supabase (ra√≠z):", rootResult);
            data = rootResult.data;
            error = rootResult.error;
          }

          if (error) {
            console.error("Error al listar videos:", error);
            loading.innerHTML = `<div>Error: ${error.message}</div>`;
            videoTitle.textContent = "Error al cargar videos";
            return;
          }

          const videosUsuario = [];
          if (data && data.length > 0) {
            console.log(`Se encontraron ${data.length} archivos/carpetas`);

            const userFolderItem = data.find((item) => item.name === userEmail);

            if (userFolderItem && userFolderItem.id) {
              console.log(
                "Encontrada carpeta del usuario, listando su contenido..."
              );
              const { data: filesInFolder, error: folderError } =
                await supabaseClient.storage.from("videos").list(userEmail, {
                  limit: 100,
                  sortBy: { column: "name", order: "asc" },
                });

              console.log("Archivos dentro de la carpeta:", {
                filesInFolder,
                folderError,
              });

              if (!folderError && filesInFolder) {
                filesInFolder.forEach((file) => {
                  console.log("Archivo encontrado:", file);
                  if (file.name && file.name.match(/\.(mp4|webm|ogg)$/i)) {
                    const videoUrl = supabaseClient.storage
                      .from("videos")
                      .getPublicUrl(`${userEmail}/${file.name}`).data.publicUrl;
                    console.log("Video agregado:", file.name, videoUrl);
                    videosUsuario.push({
                      name: file.name.replace(/\.[^/.]+$/, ""),
                      url: videoUrl,
                      esPublicidad: false,
                    });
                  }
                });
              }
            } else {
              data.forEach((file) => {
                console.log("Archivo encontrado:", file);
                if (file.name && file.name.match(/\.(mp4|webm|ogg)$/i)) {
                  const videoUrl = supabaseClient.storage
                    .from("videos")
                    .getPublicUrl(`${userFolder}${file.name}`).data.publicUrl;
                  console.log("Video agregado:", file.name, videoUrl);
                  videosUsuario.push({
                    name: file.name.replace(/\.[^/.]+$/, ""),
                    url: videoUrl,
                    esPublicidad: false,
                  });
                }
              });
            }
          } else {
            console.log("No se encontraron archivos en la carpeta");
          }

          const { data: publicidadData } = await supabaseClient.storage
            .from("videos")
            .list("", { limit: 1, search: VIDEO_PUBLICITARIO });
          if (publicidadData && publicidadData.length > 0) {
            videosUsuario.push({
              name: VIDEO_PUBLICITARIO.replace(/\.[^/.]+$/, ""),
              url: supabaseClient.storage
                .from("videos")
                .getPublicUrl(VIDEO_PUBLICITARIO).data.publicUrl,
              esPublicidad: true,
            });
          }
          videos = videosUsuario;
          if (videos.length > 0) {
            renderVideoList();
            loadVideo(0);
            loading.style.display = "none";
          } else {
            loading.innerHTML = `<div>No tienes videos a√∫n</div>`;
            videoTitle.textContent = "No hay videos";
          }
        } catch (error) {
          videoTitle.textContent = "Error de conexi√≥n";
          loading.innerHTML = `<div>Error de conexi√≥n</div>`;
        }
      }
      function renderVideoList() {
        videoList.innerHTML = "";
        videos.forEach((video, index) => {
          const item = document.createElement("div");
          const isActive = index === currentVideoIndex;
          item.className = `video-item ${isActive ? "active" : ""} ${
            video.esPublicidad ? "publicidad" : ""
          }`;
          item.innerHTML = `<div class="video-item-title">${video.name}${
            video.esPublicidad
              ? '<span class="ad-badge">üì¢ Publicidad</span>'
              : ""
          }</div>`;
          item.addEventListener("click", () => {
            loadVideo(index);
            toggleSidebar();
          });
          videoList.appendChild(item);
        });
      }
      function loadVideo(index) {
        if (index < 0 || index >= videos.length) return;
        currentVideoIndex = index;
        const video = videos[index];
        videoElement.pause();
        videoElement.src = video.url;
        videoElement.load();
        videoTitle.textContent = video.esPublicidad
          ? `üì¢ ${video.name}`
          : video.name;
        isPlaying = false;
        playPauseBtn.textContent = "‚ñ∂";
        if (posterImg) {
          posterImg.setAttribute("animation", {
            property: "scale",
            from: "0 0 0",
            to: "1 1 1",
            dur: 500,
            easing: "easeInOutQuad",
          });
        }
        renderVideoList();
      }
      function togglePlayPause() {
        if (isPlaying) {
          videoElement.pause();
          playPauseBtn.textContent = "‚ñ∂";
          if (videoCircle)
            videoCircle.setAttribute("animation", {
              property: "scale",
              from: "1 1 1",
              to: "0 0 0",
              dur: 3000,
              easing: "easeInOutQuad",
            });
          if (ringInner)
            ringInner.setAttribute("animation", {
              property: "scale",
              from: "1 1 1",
              to: "0 0 0",
              dur: 3000,
              easing: "easeInOutQuad",
            });
          if (ringOuter)
            ringOuter.setAttribute("animation", {
              property: "scale",
              from: "1 1 1",
              to: "0 0 0",
              dur: 3000,
              easing: "easeInOutQuad",
            });

          setTimeout(() => {
            if (posterImg)
              posterImg.setAttribute("animation", {
                property: "scale",
                from: "0 0 0",
                to: "1 1 1",
                dur: 500,
                easing: "easeInOutQuad",
              });
          }, 3000);
          isPlaying = false;
        } else {
          hidePoster();
          setTimeout(() => {
            videoElement.play();
            playPauseBtn.textContent = "‚è∏";
            if (videoCircle)
              videoCircle.setAttribute("animation", {
                property: "scale",
                from: "0 0 0",
                to: "1 1 1",
                dur: 3000,
                easing: "easeInOutQuad",
              });
            if (ringInner)
              ringInner.setAttribute("animation", {
                property: "scale",
                from: "0 0 0",
                to: "1 1 1",
                dur: 3000,
                easing: "easeInOutQuad",
              });
            if (ringOuter)
              ringOuter.setAttribute("animation", {
                property: "scale",
                from: "0 0 0",
                to: "1 1 1",
                dur: 3000,
                easing: "easeInOutQuad",
              });

            isPlaying = true;
          }, 500);
        }
      }
      videoElement.addEventListener("ended", function () {
        if (videoCircle)
          videoCircle.setAttribute("animation", {
            property: "scale",
            from: "1 1 1",
            to: "0 0 0",
            dur: 3000,
            easing: "easeInOutQuad",
          });
        if (ringInner)
          ringInner.setAttribute("animation", {
            property: "scale",
            from: "1 1 1",
            to: "0 0 0",
            dur: 3000,
            easing: "easeInOutQuad",
          });
        if (ringOuter)
          ringOuter.setAttribute("animation", {
            property: "scale",
            from: "1 1 1",
            to: "0 0 0",
            dur: 3000,
            easing: "easeInOutQuad",
          });

        setTimeout(() => {
          if (posterImg)
            posterImg.setAttribute("animation", {
              property: "scale",
              from: "0 0 0",
              to: "1 1 1",
              dur: 500,
              easing: "easeInOutQuad",
            });
        }, 3000);
        isPlaying = false;
        playPauseBtn.textContent = "‚ñ∂";
        videoElement.currentTime = 0;
      });
      function toggleSidebar() {
        sidebar.classList.toggle("open");
        menuBtn.classList.toggle("active");
      }
      playPauseBtn.addEventListener("click", togglePlayPause);
      menuBtn.addEventListener("click", toggleSidebar);
      const reloadBtn = document.querySelector("#reload-btn");
      reloadBtn.addEventListener("click", () => {
        location.reload();
      });
      if (!checkSession()) {
        authScreen.classList.remove("hidden");
      }
    </script>
  </body>
</html>